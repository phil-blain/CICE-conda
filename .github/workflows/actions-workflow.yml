name: Catalina
# This workflow is triggered on pushes to the repository.
on: [push]

jobs:
  build:
    name: "conda-env Catalina"
    # This job runs on macOS 10.15 Catalina
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v1
      - name: system info
        run: |
          which wget
          which curl
          python -c 'import os, sys; print os.path.realpath(sys.argv[1])' $(which csh)
          csh -v
          uname -a
          sw_vers
          xcrun --show-sdk-path
          xcode-select -p
      - name : install conda
        run: |
          wget https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O ~/miniconda.sh
          bash ~/miniconda.sh -b -p $HOME/miniconda
      - name: clone CICE
        run: |
          git clone --recurse-submodules --branch master --single-branch --depth=1 --shallow-submodules https://github.com/CICE-Consortium/CICE.git $HOME/cice
      - name: setup conda env
        run: |
          cd $HOME && mkdir -p cice-dirs/runs cice-dirs/baseline cice-dirs/input
          source $HOME/miniconda/bin/activate
          conda init zsh
          cd $HOME/cice
          conda env create -f configuration/scripts/machines/environment.yml
      - name: check conda env
        run: |
          zsh -c 'source $HOME/.zshrc && conda activate cice && which clang && which gfortran && which mpifort && which mpicc && which make'
          cat $HOME/miniconda/envs/cice/etc/conda/activate.d/activate_clang_osx-64.sh
      - name: download input data
        run: |
          wget ftp://ftp.cgd.ucar.edu/archive/Model-Data/CICE/CICE_data_ic_grid.tar.gz && tar xvfz CICE_data_ic_grid.tar.gz -C ~
          wget ftp://ftp.cgd.ucar.edu/archive/Model-Data/CICE/CICE_data_forcing_gx3_all.tar.gz && tar xvfz CICE_data_forcing_gx3_all.tar.gz -C ~
      - name: compile CICE
        run: |
          cd $HOME/cice
          ./cice.setup -m conda -e macos -c ~/cice-dirs/cases/case1
          cd ~/cice-dirs/cases/case1
          zsh -c 'source $HOME/.zshrc && ./cice.build'
      - name: run CICE
        run: |
          cd ~/cice-dirs/cases/case1
          zsh -c 'source $HOME/.zshrc && ./cice.run'
